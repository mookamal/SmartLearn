{% extends "_base.html" %}
{% load static %}
{% load exam_tags %}
{% block title %}Session Results{% endblock title %}

{% block content %}

{% include "exams/parts/navbar.html" %}
{% include "exams/parts/sidebar.html" %} 
<div class="p-4 sm:ml-64 mt-14">
    <h1 class="my-4 text-center text-2xl font-extrabold leading-none tracking-tight text-gray-900 md:text-3xl lg:text-4xl dark:text-white">Session <mark class="px-2 text-white bg-blue-600 rounded dark:bg-blue-500">#{{session.id}}</mark> results</h1>
    <hr class="w-48 h-1 mx-auto my-4 bg-primary-100 border-0 rounded md:my-10 dark:bg-gray-700">
    {% comment %} show charts {% endcomment %}
    <div class="flex justify-around flex-col lg:flex-row p-6 gap-2 rounded-lg shadow-sm dark:bg-gray-800 dark:border-gray-700 dark:hover:bg-gray-700">
        {% comment %} charts card {% endcomment %}
        <div class="max-w-sm w-full bg-white rounded-lg shadow dark:bg-gray-800 p-4 md:p-6">

            <h5 class="text-xl font-bold leading-none text-gray-900 dark:text-white text-center">Session performance</h5>
            <hr class="border mt-3">

            <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg">
                <div class="grid grid-cols-3 gap-3 mb-2">
                   <dl class="bg-yellow-200 dark:bg-gray-600 rounded-lg flex flex-col items-center justify-center h-[78px]">
                        <dt class="w-8 h-8 rounded-full bg-orange-100 dark:bg-gray-500 text-orange-600 dark:text-orange-300 text-sm font-medium flex items-center justify-center mb-1">
                        {{session.skipped_answer_count}}
                        </dt>
                        <dd class="text-orange-600 dark:text-orange-300 text-sm font-medium">Skipped</dd>
                   </dl>
                   <dl class="bg-green-400 dark:bg-gray-600 rounded-lg flex flex-col items-center justify-center h-[78px]">
                      <dt class="w-8 h-8 rounded-full bg-teal-100 dark:bg-gray-500 text-teal-600 dark:text-teal-300 text-sm font-medium flex items-center justify-center mb-1">
                        {{session.correct_answer_count}}
                      </dt>
                      <dd class="text-teal-600 dark:text-teal-300 text-sm font-medium">Correct</dd>
                   </dl>
                   <dl class="bg-red-400 dark:bg-gray-600 rounded-lg flex flex-col items-center justify-center h-[78px]">
                        <dt class="w-8 h-8 rounded-full bg-blue-100 dark:bg-gray-500 text-blue-600 dark:text-blue-300 text-sm font-medium flex items-center justify-center mb-1">
                            {{session.incorrect_answer_count}}
                        </dt>
                        <dd class="text-blue-600 dark:text-blue-300 text-sm font-medium">
                            Incorrect
                        </dd>
                   </dl>
                </div>
             </div>
            <!-- Line Chart -->
            <div class="py-6" id="session-chart"></div>
         </div>
         {% comment %} details card {% endcomment %}
         <div class="max-w-sm w-full bg-white rounded-lg shadow dark:bg-gray-800 p-4 md:p-6 flex flex-col justify-between">
            <h5 class="text-xl font-bold leading-none text-gray-900 dark:text-white text-center">of questions responded to correctly</h5>
            <hr class="border mt-3">
            <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg flex justify-around text-xl items-center font-bold">
                <i class="fa-solid fa-check-double text-green-400"></i> <span>{{percentage_correct_answer}}%</span>
            </div>
            <hr class="w-48 h-1 mx-auto my-4 bg-gray-100 border-0 rounded md:my-10 dark:bg-gray-700">

            {% comment %} actions {% endcomment %}
            {% comment %} for all {% endcomment %}
            <button type="button" id="reExamineAll" class="w-full p-2 me-2 my-2 text-sm font-medium text-gray-900 focus:outline-none bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-4 focus:ring-gray-100 dark:focus:ring-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700">
              Re-examine on <span class="font-bold bg-primary-300 p-1 rounded dark:text-primary-950">all</span> questions ({{session.number_of_questions}})
            </button>
            {% comment %} for skipped {% endcomment %}
            {% if session.skipped_answer_count > 0 %}
            <button type="button" id="reExamineSkipped" class="w-full p-2 me-2 my-2 text-sm font-medium text-gray-900 focus:outline-none bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-4 focus:ring-gray-100 dark:focus:ring-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700">
              Re-examine on <span class="font-bold bg-yellow-200 p-1 rounded dark:text-primary-950">Skipped</span> questions ({{session.skipped_answer_count}})
            </button>
            {% endif %}
            {% comment %} for incorrect {% endcomment %}
            {% if session.incorrect_answer_count > 0 %}
            <button type="button" id="reExamineIncorrect" class="w-full p-2 me-2 my-2 text-sm font-medium text-gray-900 focus:outline-none bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-4 focus:ring-gray-100 dark:focus:ring-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700">
              Re-examine on <span class="font-bold bg-red-400 p-1 rounded dark:text-primary-950">Incorrect</span> questions ({{session.incorrect_answer_count}})
            </button>
            {% endif %}
            <hr class="w-48 h-1 mx-auto my-4 bg-gray-100 border-0 rounded md:my-10 dark:bg-gray-700">
            {% comment %} show created at {% endcomment %}
            <p class="text-gray-600 dark:text-gray-400 text-center">Created at: {{ session.created_at }}</p>
         </div>

         {% comment %} End details card {% endcomment %}
    </div>
    {% comment %} End show charts {% endcomment %}
    {% comment %} End show question table {% endcomment %}
    <div class="p-6 gap-2 rounded-lg shadow-sm dark:bg-gray-800 dark:border-gra">
      <table id="question-table" class="border bg-white dark:bg-black dark:border-black shadow-sm">
        <thead>
            <tr>
                <th>
                    <span class="flex items-center">
                        Status
                    </span>
                </th>
                <th>
                    <span class="flex items-center">
                        Text
                    </span>
                </th>
                <th>
                    <span class="flex items-center">
                        Subject
                    </span>
                </th>
                <th>
                    <span class="flex items-center">
                      Correct others (%)
                    </span>
                </th>
            </tr>
        </thead>
        <tbody>
          {% for question in session.questions.all %}
            <tr class="hover:bg-gray-100">
                <td class="text-xl">
                  {{ session.id|question_status:question.id|safe }}
                  <p class="text-yellow-200 hidden"></p>
                  <p class="text-red-400 hidden"></p>
                </td>
                <td>{{question.text}}</td>
                <td>{{question.subject}}</td>
                <td>{{ question.id|percentage_question }}%</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% comment %} show question table {% endcomment %}
</div>
{% endblock content %}
{% block js %}
<script src="{% static "src/js/apexcharts.js" %}"></script>
<script>
const getChartOptions = () => {
    return {
      series: [{{percentage_correct_answer}}, {{percentage_incorrect_answer}}, {{percentage_skipped_answer}}],
      colors: ["#31C48D", "#F98080", "#FCE96A"],
      chart: {
        height: 420,
        width: "100%",
        type: "pie",
      },
      stroke: {
        colors: ["white"],
        lineCap: "",
      },
      plotOptions: {
        pie: {
          labels: {
            show: true,
          },
          size: "100%",
          dataLabels: {
            offset: -25
          }
        },
      },
      labels: ["Correct", "Incorrect", "Skipped"],
      dataLabels: {
        enabled: true,
        style: {
          fontFamily: "Inter, sans-serif",
        },
      },
      legend: {
        position: "bottom",
        fontFamily: "Inter, sans-serif",
      },
      yaxis: {
        labels: {
          formatter: function (value) {
            return value + "%"
          },
        },
      },
      xaxis: {
        labels: {
          formatter: function (value) {
            return value  + "%"
          },
        },
        axisTicks: {
          show: false,
        },
        axisBorder: {
          show: false,
        },
      },
    }
  }
  
  if (document.getElementById("session-chart") && typeof ApexCharts !== 'undefined') {
    const chart = new ApexCharts(document.getElementById("session-chart"), getChartOptions());
    chart.render();
  }
  
</script>
<script src="https://cdn.jsdelivr.net/npm/simple-datatables@9.0.3"></script>
<script>
  // for data table to display question
  if (document.getElementById("question-table") && typeof simpleDatatables.DataTable !== 'undefined') {
    const dataTable = new simpleDatatables.DataTable("#question-table", {
        searchable: true,
        sortable: true
    });
}
</script>
<script>
  // for actions
  /**
   * This function sends a request to the server to re-examine the session.
   *
   * @param {string} action - The action to be performed during re-examination.
   *                          It can be either "all" or "incorrect".
   *
   * @returns {void} - The function does not return any value.
   */
  function reExamine(action) {
        // run loader
        showLoader();
        const data = {
          session_id: "{{ session.id }}",
          action: action,
        };
        // send request to re_examine url
        $.ajax({
          url: "{% url 're_examine' %}",
          method: "POST",
          data: JSON.stringify(data),
          contentType: "application/json",
          headers: {'X-CSRFToken': '{{ csrf_token }}'},
          success: function (response) {
            // hide loader
            hideLoader();
            if (response.session_id) {
              confirmAction(`Re-examined successfully. (${action})` , "success", function () {
                const redirectUrl = "{% url 'show_session' session_id=0 %}".replace("0", response.session_id);
                window.location.href = redirectUrl;
              });
            }

          },
          error: function (xhr, status, error) {
            // hide loader
            hideLoader();
            // show error message
            console.log("Failed to re-examine. Please try again later.");
          },
        });
    }

  $("#reExamineAll").click(
    function () {
      reExamine("all");
    }
  );
  $("#reExamineSkipped").click(
    function () {
      reExamine("skipped");
    }
  );
  $("#reExamineIncorrect").click(
    function () {
      reExamine("incorrect");
    }
  );
</script>
{% endblock js %}