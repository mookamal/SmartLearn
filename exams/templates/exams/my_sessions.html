{% extends "_base.html" %}

{% block title %}My Sessions{% endblock title %}

{% block content %}
{% include "exams/parts/navbar.html" %}
{% include "exams/parts/sidebar.html" %} 
<div class="p-4 sm:ml-64 mt-14">
    <h1 class="my-4 text-center text-2xl font-extrabold leading-none tracking-tight text-gray-900 md:text-3xl lg:text-4xl dark:text-white">
        My Sessions
    </h1>
    <hr class="w-48 h-1 mx-auto my-4 bg-primary-100 border-0 rounded md:my-10 dark:bg-gray-700">
    {% comment %} show session as tables {% endcomment %}
    {% if sessions %}
      <div class="flex p-6 justify-center md:justify-end">
        <button type="button" id="delete-all-sessions" class="text-white bg-red-400 hover:bg-red-800 focus:outline-none focus:ring-4 focus:ring-red-300 font-medium rounded-full text-sm px-5 py-2.5 text-center me-2 mb-2 dark:bg-red-600 dark:hover:bg-red-700 dark:focus:ring-red-900">
          <i class="fa-solid fa-trash"></i>
          Delete all sessions
        </button>
      </div>
    {% endif %}
    <div class="p-6 gap-2 rounded-lg shadow-sm dark:bg-gray-800 dark:border-gra">
        <table id="session-table" class="border bg-white dark:bg-black dark:border-black shadow-sm">
          <thead>
              <tr>
                  <th>
                      <span class="flex items-center">
                          Session
                      </span>
                  </th>
                  <th>
                      <span class="flex items-center">
                          Date
                      </span>
                  </th>
                  <th>
                      <span class="flex items-center">
                          Questions
                      </span>
                  </th>
                  <th>
                      <span class="flex items-center">
                        Score
                      </span>
                  </th>
                  <th>
                    <span class="flex items-center">
                      Actions
                    </span>
                </th>
              </tr>
          </thead>
          <tbody>
            {% for session in sessions %}
              <tr class="hover:bg-gray-100 dark:hover:bg-gray-950">
                  <td class="bg-yellow-50 dark:bg-gray-800">{{session.exam.category.name}} #{{session.id}}</td>
                  <td>{{session.created_at}}</td>
                  <td class="bg-yellow-50 dark:bg-gray-800">{{session.number_of_questions}}</td>
                  <td>
                    {% include "exams/parts/session_score_column.html" %}
                  </td>
                  <td class="bg-yellow-50 dark:bg-gray-800 flex justify-center">
                    {% include "exams/parts/session_actions_column.html" %}
                  </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
    </div>
</div>
{% endblock content %}
{% block js %}
<script src="https://cdn.jsdelivr.net/npm/simple-datatables@9.0.3"></script>
<script>
    // for data table to display question
    if (document.getElementById("session-table") && typeof simpleDatatables.DataTable !== 'undefined') {
      const dataTable = new simpleDatatables.DataTable("#session-table", {
          searchable: true,
          sortable: true
      });
  }
</script>
<script>
    // for actions
  /**
   * This function sends a request to the server to re-examine the session.
   *
   * @param {string} action - The action to be performed during re-examination.
   *                          It can be either "all" or "incorrect".
   *
   * @returns {void} - The function does not return any value.
   */
   function reExamine(sessionId) {
    // run loader
    showLoader();
    const data = {
      session_id: sessionId,
      action: "all",
    };
    // send request to re_examine url
    $.ajax({
      url: "{% url 're_examine' %}",
      method: "POST",
      data: JSON.stringify(data),
      contentType: "application/json",
      headers: {'X-CSRFToken': '{{ csrf_token }}'},
      success: function (response) {
        // hide loader
        hideLoader();
        if (response.session_id) {
          confirmAction(`Re-examined successfully.` , "success", function () {
            const redirectUrl = "{% url 'show_session' session_id=0 %}".replace("0", response.session_id);
            window.location.href = redirectUrl;
          });
        }

      },
      error: function (error) {
        // hide loader
        hideLoader();
        // show error message
        setAlert(error.responseJSON.error,'error')
      },
    });
}
$(".re-examine").click(function (event) {
  event.preventDefault();
  const sessionId = $(this).data("session-id");
  reExamine(sessionId);
});
</script>
<script>
  function deleteSession(action, sessionId = null) {
    const message = action === 'all' 
                    ? "Are you sure you want to delete all sessions?" 
                    : "Are you sure you want to delete this session?";

    confirmAction(message, "warning", function () {
      $.ajax({
        url: "{% url 'delete_session' %}",
        method: "POST",
        data: JSON.stringify({ 
          action: action,
          session_id: sessionId
        }),
        contentType: "application/json",
        headers: { 'X-CSRFToken': '{{ csrf_token }}' },
        success: function (response) {
          if (response.success) {
            window.location.reload();
          } else {
            console.log("Failed to delete session. Please try again later.");
          }
        },
        error: function (xhr, status, error) {
          console.log("Failed to delete session. Please try again later.");
        },
      });
    });
  }


  $(".delete-session").click(function (event) {
    event.preventDefault();
    const sessionId = $(this).data("session-id");
    deleteSession('single', sessionId);
  });

  $("#delete-all-sessions").click(function (event) {
    event.preventDefault();
    deleteSession('all');
  });
</script>

{% endblock js %}